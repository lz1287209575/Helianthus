# Helianthus 项目 TODO 列表

## 🎯 当前状态总结

### 🎉 最新完成的重要工作（2025-08-26）
- [x] **死信队列系统完整实现**：过期消息处理、拒收消息处理、重试机制、指数退避算法
- [x] **消息队列死锁问题彻底解决**：修复了SendMessage、ReceiveMessage、RejectMessage中的死锁问题
- [x] **日志系统文件名行号修复**：H_LOG宏现在正确显示调用位置而不是宏定义位置
- [x] **完整的死信队列测试**：创建了多个测试用例验证DLQ功能
- [x] **DLQ监控系统完整实现**：死信队列统计、告警机制、监控API、实时监控功能

### ✅ 已完成的核心功能
- [x] **日志系统完善**：自定义格式化器、分类日志、大写完整单词显示、正确的文件名和行号显示
- [x] **消息队列基础架构**：队列管理、消息路由、持久化框架
- [x] **消息队列死锁修复**：解决SendMessage、ReceiveMessage、RejectMessage中的死锁问题
- [x] **网络框架**：异步I/O、多平台支持、连接管理
- [x] **服务发现系统**：服务注册、健康检查、负载均衡
- [x] **反射系统**：UE风格反射、自动注册、类型信息
- [x] **脚本引擎**：多语言支持、热更新、沙箱执行
- [x] **配置系统**：多格式支持、配置继承、加密存储
- [x] **RPC框架**：服务端/客户端、异步调用、错误处理
- [x] **性能监控**：指标收集、性能分析、资源监控

## 🚧 消息队列系统完善

### 死信队列系统（DLQ）
- [x] **过期消息处理**：实现消息TTL机制，过期消息自动路由到DLQ ✅
- [x] **拒收消息处理**：消费者拒收消息的路由策略 ✅
- [x] **重投策略**：指数退避、最大重试次数、可配置策略 ✅
- [x] **DLQ监控**：死信队列长度、消息统计、告警机制 ✅

### 消息重试机制
- [x] **指数退避算法**：实现标准的指数退避重试策略 ✅
- [x] **最大重试次数**：可配置的重试上限 ✅
- [x] **重试策略配置**：线性退避、指数退避、固定间隔 ✅
- [x] **重试状态跟踪**：消息重试历史、失败原因分析 ✅

### 事务支持
- [x] **发送/确认原子性**：确保消息发送和确认的原子操作 ✅
- [x] **事务回滚**：支持事务失败时的消息回滚 ✅
- [x] **分布式事务**：跨服务的事务协调机制 ✅
- [x] **事务监控**：事务成功率、回滚率统计 ✅

## 📊 可观测性完善

### 结构化日志字段统一
- [ ] **日志字段标准化**：统一所有日志的字段格式
- [ ] **上下文信息**：请求ID、用户ID、会话ID等上下文
- [ ] **性能指标**：响应时间、吞吐量、错误率
- [ ] **业务指标**：业务操作成功率、关键路径监控

### 指标系统
- [x] **队列长度监控（基础版）**：实时队列长度、入/出队速率（滑动窗口）
- [x] **消息处理延迟（基础版）**：处理时延 P50/P95（基于样本近似）
- [ ] **持久化耗时**：磁盘写入时间、读取时间统计
- [ ] **资源使用率**：CPU、内存、磁盘、网络使用率

配置项（全局配置 SetGlobalConfig 生效）
- `metrics.interval.ms`：指标输出与采样刷新间隔（默认 5000）
- `metrics.window.ms`：速率计算滑动窗口毫秒数（默认 60000）
- `metrics.latency.capacity`：时延样本最大容量（默认 512）

示例使用（代码中）：
```cpp
queue->SetGlobalConfig("metrics.interval.ms", "2000");
queue->SetGlobalConfig("metrics.window.ms", "60000");
queue->SetGlobalConfig("metrics.latency.capacity", "1024");
```

### 监控告警
- [x] **告警级别和类型**：INFO、WARNING、ERROR、CRITICAL 级别，队列满、队列空、高延迟、低吞吐量、死信队列、消费者离线、磁盘空间、内存使用率、CPU使用率、网络错误、持久化错误、压缩错误、加密错误、事务超时、复制滞后、节点健康、自定义告警等类型 ✅
- [x] **告警配置管理**：支持阈值、持续时间、冷却时间、通知渠道等配置 ✅
- [x] **告警信息记录**：包含告警ID、类型、级别、消息、当前值、阈值、触发时间、活跃状态、发生次数、详细信息 ✅
- [x] **告警统计系统**：总告警数、活跃告警数、各级别告警数、平均解决时间 ✅
- [x] **告警回调机制**：告警事件回调和告警配置变更回调 ✅
- [x] **告警管理API**：设置、查询、删除告警配置，查询活跃告警、告警历史、告警统计，确认、解决、清空告警 ✅

## 🔧 网络框架优化

### 事件循环优化
- [ ] **背压控制**：防止消息积压，实现流量控制
- [ ] **事件批处理**：批量处理事件，提高吞吐量
- [ ] **负载均衡**：连接负载均衡、消息分发优化
- [ ] **连接池优化**：连接复用、连接预热

### 减少拷贝
- [ ] **零拷贝技术**：使用sendfile、splice等零拷贝API
- [ ] **内存池**：自定义内存池，减少内存分配开销
- [ ] **缓冲区优化**：环形缓冲区、预分配缓冲区
- [ ] **序列化优化**：高效的序列化/反序列化

## 🚀 高级功能

### 消息压缩/加密
- [x] **压缩算法支持**：GZIP、LZ4、ZSTD、Snappy 压缩算法 ✅
- [x] **加密算法支持**：AES-256-GCM、ChaCha20-Poly1305、AES-128-CBC 加密算法 ✅
- [x] **自动压缩/加密**：根据配置自动应用压缩和加密 ✅
- [x] **压缩/加密统计**：压缩比、加密时间等性能指标 ✅

### 分片与副本
- [ ] **消息分片**：大消息自动分片、分片重组
- [ ] **队列分片**：水平分片、垂直分片策略
- [ ] **数据副本**：主从复制、多副本一致性
- [ ] **故障转移**：自动故障检测、主从切换

### 热点缓存
- [ ] **热点检测**：自动识别热点数据
- [ ] **缓存策略**：LRU、LFU、TTL等缓存策略
- [ ] **缓存预热**：系统启动时的缓存预热
- [ ] **缓存失效**：智能缓存失效策略

## 🚀 性能优化
- [x] **零拷贝技术**：减少内存拷贝，提高数据传输效率 ✅
- [x] **内存池管理**：自定义内存池，减少内存分配开销 ✅
- [x] **缓冲区优化**：智能缓冲区管理，动态扩容 ✅
- [x] **批处理操作**：批量消息处理，提高吞吐量 ✅
- [x] **性能统计**：详细的性能指标监控 ✅
- [x] **内存压缩**：内存池压缩，减少内存碎片 ✅

## 🔍 监控与诊断

### 健康检查
- [ ] **服务健康检查**：定期健康检查、状态报告
- [ ] **依赖健康检查**：数据库、缓存、外部服务健康检查
- [ ] **健康检查API**：RESTful健康检查接口
- [ ] **健康状态聚合**：多服务健康状态聚合

### 持久化一致性校验
- [ ] **数据校验**：CRC32、MD5、SHA256等校验算法
- [ ] **一致性检查**：定期数据一致性检查
- [ ] **修复机制**：自动修复、手动修复工具
- [ ] **校验报告**：详细的校验报告和修复建议

### 离线修复工具
- [ ] **数据修复工具**：命令行数据修复工具
- [ ] **队列修复工具**：损坏队列的修复工具
- [ ] **索引重建工具**：索引损坏时的重建工具
- [ ] **数据迁移工具**：数据格式升级、迁移工具

## 🧪 测试完善

### 单元测试
- [ ] **消息队列测试**：完整的消息队列功能测试
- [ ] **持久化测试**：文件持久化、数据库持久化测试
- [ ] **网络测试**：网络框架的全面测试
- [ ] **性能测试**：压力测试、性能基准测试

### 集成测试
- [ ] **端到端测试**：完整的消息处理流程测试
- [ ] **故障恢复测试**：系统故障时的恢复测试
- [ ] **负载测试**：高负载下的系统稳定性测试
- [ ] **长时间运行测试**：7x24小时稳定性测试

### 性能测试
- [ ] **吞吐量测试**：消息处理吞吐量测试
- [ ] **延迟测试**：端到端延迟测试
- [ ] **资源使用测试**：CPU、内存、磁盘使用率测试
- [ ] **并发测试**：高并发场景下的性能测试

## 📚 文档完善

### API文档
- [ ] **消息队列API文档**：完整的API使用说明
- [ ] **网络框架API文档**：网络API使用指南
- [ ] **配置文档**：配置项详细说明
- [ ] **示例代码**：丰富的使用示例

### 部署文档
- [ ] **部署指南**：详细的部署步骤
- [ ] **配置指南**：生产环境配置建议
- [ ] **监控指南**：监控系统部署和配置
- [ ] **故障排查**：常见问题排查指南

### 运维文档
- [ ] **运维手册**：日常运维操作指南
- [ ] **故障处理**：故障处理流程和预案
- [ ] **性能调优**：性能调优指南
- [ ] **安全指南**：安全配置和最佳实践

## 🎯 优先级建议

### 高优先级（立即开始）
1. **结构化日志字段统一**：改善可观测性
2. **队列长度监控**：基础监控指标
3. **事务支持**：提高数据一致性
4. **性能优化**：消息处理性能优化

### 中优先级（近期完成）
1. **事务支持**：提高数据一致性
2. **压缩/加密**：提高安全性和效率
3. **健康检查**：提高系统可用性
4. **性能测试**：确保系统性能

### 低优先级（长期规划）
1. **分片与副本**：提高系统扩展性
2. **热点缓存**：优化性能
3. **离线修复工具**：运维支持
4. **高级监控**：深度监控能力

## 📈 项目里程碑

### 里程碑1：消息队列完善（已完成 ✅）
- [x] 死信队列系统
- [x] 消息重试机制
- [x] 基础监控指标（队列长度/速率、处理时延 P50/P95）

### 里程碑2：可观测性完善（2-3周）
- [ ] 结构化日志统一
- [ ] 监控告警系统
- [ ] 健康检查机制

### 里程碑3：高级功能（3-4周）
- [ ] 事务支持
- [ ] 压缩加密
- [ ] 性能优化

### 里程碑4：生产就绪（2-3周）
- [ ] 完整测试覆盖
- [ ] 文档完善
- [ ] 部署工具

---

**当前重点**：可观测性系统的完善，包括结构化日志统一和队列长度监控，这将显著提高系统的可观测性和运维能力。

### 负载均衡、副本、HA分片
- [x] **集群类型定义**：NodeId、ShardId、ReplicaInfo、ClusterConfig等基础类型 ✅
- [x] **一致性哈希分片路由**：ConsistentHashRing实现，支持虚拟节点 ✅
- [x] **集群API接口**：SetClusterConfig、GetClusterConfig、GetShardForKey等 ✅
- [x] **副本角色与健康**：Leader/Follower角色，健康状态管理 ✅
- [x] **健康感知路由**：优先健康Leader，回退健康Follower ✅
- [x] **心跳线程**：轻量级心跳，模拟健康波动 ✅
- [x] **Leader选举**：基础内存选举，基于健康状态 ✅
- [x] **故障转移回调**：SetLeaderChangeHandler、SetFailoverHandler ✅
- [x] **分片状态导出**：GetClusterShardStatuses API ✅
- [x] **WAL骨架**：每分片日志与Follower位点 ✅
- [x] **复制指标**：复制滞后度、ACK计数 ✅
- [x] **Follower位点推进**：心跳中周期性推进（模拟重放） ✅
- [x] **路由容错增强**：主失效自动回退与重试幂等 ✅
- [x] **HA演示文档**：新增failover_demo示例并更新README/Examples文档 ✅
